const { Telegraf, Markup } = require('telegraf');
const fs = require('fs');
const path = require('path');

// Конфигурация бота
const BOT_TOKEN = '8432249611:AAHWMs9ZysSoRuKVxhGdO-FE-bPP2xyWmXs';
const GROUP_ID = '-1002540229091'; // Замените на реальный ID группы
const IMAGES_FOLDER = 'images';

// Создаем папку для изображений, если ее нет
if (!fs.existsSync(IMAGES_FOLDER)) {
    fs.mkdirSync(IMAGES_FOLDER);
    console.log('✅ Папка для изображений создана');
}

// Инициализация бота
const bot = new Telegraf(BOT_TOKEN);

// Данные товаров с именами файлов
const seatCovers = [
    { id: 1, name: 'Черная алькантара / Черная экокожа', photo: '1.jpg' },
    { id: 2, name: 'Экокожа белая', photo: '2.jpg' },
    { id: 3, name: 'Синяя алькантара / Черная экокожа', photo: '3.jpg' },
    { id: 4, name: 'Черная экокожа / Оранжевая экокожа', photo: '4.jpg' },
    { id: 5, name: 'Темно-серая экокожа', photo: '5.jpg' },
    { id: 6, name: 'Черная экокожа / Слоновая кость экокожа', photo: '6.jpg' },
    { id: 7, name: 'Черная экокожа', photo: '7.jpg' },
    { id: 8, name: 'Черная экокожа / Серая экокожа', photo: '8.jpg' },
    { id: 9, name: 'Перевернутый бугатти', photo: '9.jpeg' },
    { id: 10, name: 'Ромб люкс', photo: '10.png' },
    { id: 11, name: 'Анаконда алькантара', photo: '11.jpeg' },
    { id: 12, name: 'Экстра', photo: '12.jpeg' },
    { id: 13, name: 'Броня', photo: '13.jpg' },
    { id: 14, name: 'Жук', photo: '14.jpeg' },
    { id: 15, name: 'Супер узкая классика', photo: '15.jpg' },
    { id: 16, name: 'Анаконда экокожа', photo: '16.jpg' },
    { id: 17, name: 'Классика под оригинал', photo: '17.jpg' },
    { id: 18, name: 'Паук алькантара', photo: '18.jpg' },
    { id: 19, name: 'Галочки', photo: '19.jpg' },
    { id: 20, name: 'Аллигатор', photo: '20.jpg' },
    { id: 21, name: 'Каркасные Под оригинал', photo: '21.png' },
    { id: 22, name: 'Каркасные соты', photo: '22.png' },
    { id: 23, name: 'Каркасные супер узкая классика', photo: '23.png' },
    { id: 24, name: 'Каркасные ромбы', photo: '24.jpg' },
];

const carMats = [
    { id: 25, name: 'Экокожа + ворс премиум', photo: '25.jpg' },
    { id: 26, name: 'Экокожа + Ева', photo: '26.jpg' },
    { id: 27, name: 'Коврики в багажник', photo: '27.jpg' },
    { id: 28, name: 'Цвета на выбор\n13000 комплект что в салон что в багажник', photo: '28.jpg' }
];

// Файлы для информационных разделов
const infoPhotos = {
    about: 'about_us.jpg',
    install: 'installation.jpg',
    payment: 'payment_delivery.jpg'
};

// Тексты информации
const infoTexts = {
    about: `Процесс производства авточехлов
Сменные автомобильные чехлы, производимые нашей фирмой, решают сразу несколько задач:

защищают родную обшивку кресел автомобиля;
лучшают функциональность и комфортность кресел;
изменяют стилистический образ всего салона.
Сегодня мы можем изготовить авточехолы практически под любую модель любой марки автомобиля. К тому же, широкий ассортиментный ряд позволяет каждому желающему купить авточехол из кожи желаемого цвета и модели. Это разнообразие подчинено отлаженной технологии пошива: каждая модель проходит несколько классических этапов, гарантирующих ей высокое качество итогового продукта.

Этапы пошива авточехла из кожи в нашей фирме
Закупка кожи.
Наши менеджеры по закупке материалов разыскивают по всему миру поставщиков кожи, гарантирующих оптимальные условия сотрудничества. Прежде всего, берется во внимание соотношение качество/цена с учетом доставки на склад предприятия; объем и ассортимент производимых кож.

Для пошива авточехлов к креслам любой марки автомобиля требуется три вида кожи:

тонкая с подкладкой из поролона;
на обычной подкладке;
перфорированная;
Идентификация.
На этом этапе производится выбор шаблона под конкретный автомобиль клиента из ранее наработанной базы лекал под каждую модель каждой марки авто.

Раскрой.
Ответственный этап, выполняемый опытным специалистом нашей фирмы, знающим тонкости последующего пошива и особенности пропорций автомобильных кресел практически всех марок машин. Только профессионал с многолетней практикой сможет грамотно раскроить кожу, ведь машин, кресел, фасонов чехлов много и под каждую модель нужна своя индивидуальная выкройка.

Обшив края.
Технический этап, без которого получить качественное изделие из кожи не реально. Кожа обладает определенной степенью эластичности и, чтобы готовое изделие бесконтрольно не растягивалось по краю, срезы всех деталей подвергают обшивке.

Пошив.
Подготовительные этапы пройдены и остался финишный пошив: из набора разных, ранее обработанных лоскутов (разных сортов кожи) опытные швеи собирают, как из конструктора, готовое объемное изделие – автомобильный чехол. На этом этапе важно качество дополнительных материалов по работе с кожей и наличие профессионального швейного оборудования. Кожа – дорогой материал, не допускающий ошибок при пошиве. На нашем предприятии все швы и строчки выполняются качественно, надежно и с первого раза.

Доставка.
Готовое изделие транспортируется непосредственно заказчику выбранным им способом. После чего, клиент сам может произвести установку авточехлов, либо воспользоваться услугами специалистов. Именно этот момент – тест на качество всех этапов производства автомобильного чехла: выполненный нами чехол идеально «садится» на кресло.

Пять этапов – пять составляющих качества готового авточехла: наша фирма имеет все необходимое для производства идеального авточехла на ваше авто.`,

    installation: `Установка авточехлов из экокожи – это не сложное в исполнении здание. Мы уверенны, что Вам удастся правильно установить автомобильные чехлы на штатные сидения салона, для того, чтобы ощутить все преимущества нашей продукции в полной мере. Для произведения крепления необходимо воспользоваться липучкой, крючком или шнурком, в зависимости от конструктивных особенностей чехлов. Рекомендуем начинать работу по установке с переднего сидения водителя. При наличии передней подушки безопасности, следует правильно расположить шов на изделии в предусмотренном для него месте. Это необходимо для беспрепятственного выхода подушки безопасности через отверстие в случае аварийной ситуации. Экокожа – это красивый, пластичный, податливый и удобный материал, поэтому никаких проблем при установке быть не должно. Однако стоит все же быть более осторожными с острыми, колющими предметами и крючками, чтобы случайно не повредить материал. Наглядно изучить ключевые моменты установки можно с помощью инструкции. Мы отобразили весь процесс максимально доступно, чтобы вы могли выполнить его своими силами. Правильная установка автомобильных чехлов – это залог их длительной службы.`,

    payment: `Наш интернет-магазин позаботился о комфорте каждого клиента. Именно поэтому приобретенную на нашем сайте продукцию мы доставляем в любой регион России и предоставляем вам широкий выбор способов доставки и оплаты.

Как оформить заказ?
оформить заказ на сайте, добавив понравившиеся вам товары в корзину. Заказ можно сформировать в любое удобное для вас время суток. В ближайшее время после размещения заказа на сайте Vchehol.ru наши менеджеры свяжутся с вами для его подтверждения и уточнения деталей;
оформить заказ по телефону 8 (958) 510-67-67.

Способы доставки
Наш интернет-магазин позаботился о комфорте каждого клиента. Именно поэтому приобретенную на нашем сайте продукцию мы доставляем в любой регион России. Скорость доставки зависит от количества заказанных вами товаров, наличия необходимых материалов для пошива на складе компании, а также от адреса получателя.

Курьером в пределах Владимирской области. Стоимость услуги – 400 рублей. Оплата осуществляется заранее, либо наличными по факту получения заказа.
Самовывозом со склада в городе Владимир и Москва. Услуга предоставляется бесплатно.
Транспортными компанией «ПЭК», «Деловые линии». Стоимость услуги зависит от удаленности получателя от города Владимир.
«Почтой России». Стоимость услуги зависит от удаленности получателя от города Владимир.

Способы оплаты
Клиенты нашего интернет-магазина могут воспользоваться любым удобным вариантом оплаты товара.

Оплата наличными при получении заказа. Преимущество данного способа оплата – возможность лично проверить наличие и качество заказанных товаров.
Безналичный расчет для юридических лиц. Преимущество данного способа оплаты – гарантия получения товара предоставляется банком, через который производился расчет. После доставки товара вы получаете все необходимые бухгалтерские документы для отчетности.

Перевод на карту Сбербанка*. Преимущество данного способа оплаты – владельцы карты Сбербанка могут оплатить заказ без начисления специальной комиссии (Скачать реквизиты для оплаты).
Оплата наложенным платежом при доставке «Почтой России» или транспортными компаниями. Преимущество данного способа оплаты – получатель не делает предоплату, а оплачивает товар лишь по факту его получения.
Оплата при помощи платежной системы «Яндекс Деньги» без комиссии. Преимущество данного способа оплаты – возможность оплатить заказ прямо на сайте интернет-магазина сразу после его оформления.

Как это происходит: Вы оформляете заказ удобным для вас способом. Если заказ был оформлен не по телефону, то в течении суток вам позвонит наш менеджер для подтверждения заказа и уточнения деталей доставки. После этого на указанный вами адрес электронной почты поступит письмо с ссылкой на страницу оплаты вашего заказа. Все введенные вами данные проходят только через сервис «Яндекс Деньги» и полностью защищены. Мы получаем информацию только факте совершенного вами платежа.

*для оплаты (ввода реквизитов вашей карты) вы будете перенаправлены на платёжный шлюз ПАО СБЕРБАНК. Соединение с платёжным шлюзом и передача информации осуществляется в защищённом режиме с использованием протокола шифрования SSL. В случае если ваш банк поддерживает технологию безопасного проведения интернет-платежей Verified By Visa или MasterCard SecureCode, для проведения платежа также может потребоваться ввод специального пароля.

Возврат товаров и гарантия
Гарантия 1 год на всю продукицию и возможности приобрести расширенную гарантию на 2 года!

Мы производим возврат и обмен товара с полным соблюдением закона о защите прав потребителя РФ.

В течение 14 дней, не считая дня покупы. Возврат Товара надлежащего качества возможен только на основании письменного заявления в случае, если сохранены его товарный вид, потребительские свойства, а также товарный и/или кассовый чек, либо иной документ подтверждающий факт и условия покупки указанного Товара.`
};

// Состояния для консультации и заказов
const userStates = {};

// Главное меню
const mainMenu = Markup.keyboard([
    ['🚗 Авточехлы', '🛒 Автоковры'],
    ['ℹ️ О нас', '🔧 Установка'],
    ['💰 Оплата и доставка', '📞 Бесплатная консультация']
]).resize();

// Кнопка "Назад"
const backButton = Markup.keyboard(['⬅️ Назад']).resize();

// Обработка команды старт
bot.start((ctx) => {
    ctx.reply('Добро пожаловать в AutoAтельe! Выберите раздел:', mainMenu);
});

// Обработка главного меню
bot.hears('🚗 Авточехлы', (ctx) => {
    userStates[ctx.from.id] = { currentCategory: 'seatCovers' };
    showProducts(ctx, seatCovers, 'Авточехлы');
});

bot.hears('🛒 Автоковры', (ctx) => {
    userStates[ctx.from.id] = { currentCategory: 'carMats' };
    showProducts(ctx, carMats, 'Автоковры');
});

bot.hears('ℹ️ О нас', (ctx) => showInfo(ctx, 'about'));
bot.hears('🔧 Установка', (ctx) => showInstallationInfo(ctx));
bot.hears('💰 Оплата и доставка', (ctx) => showPaymentInfo(ctx));
bot.hears('📞 Бесплатная консультация', (ctx) => startConsultation(ctx));

// Функция показа товаров с локальными фото
async function showProducts(ctx, products, category) {
    for (const product of products) {
        const photoPath = path.join(IMAGES_FOLDER, product.photo);
        
        if (fs.existsSync(photoPath)) {
            try {
                await ctx.replyWithPhoto({ source: photoPath }, {
                    caption: `${product.name}.`,
                    reply_markup: Markup.inlineKeyboard([
                        Markup.button.callback('🛒 Подробнее', `order_${product.id}`)
                    ]).reply_markup
                });
            } catch (e) {
                console.error('Error sending photo:', e);
                await ctx.reply(`${product.name}\n\n[Ошибка при отправке фото]`, 
                    Markup.inlineKeyboard([
                        Markup.button.callback('🛒 Подробнее', `order_${product.id}`)
                    ]));
            }
        } else {
            await ctx.reply(`${product.name}\n\n[Фото отсутствует]`, 
                Markup.inlineKeyboard([
                    Markup.button.callback('🛒 Подробнее', `order_${product.id}`)
                ]));
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
    }
    ctx.reply('Выберите действие:', backButton);
}

// Функция показа информации об установке (текст + фото)
async function showInstallationInfo(ctx) {
    const text = infoTexts.installation;
    
    const photoPath = path.join(IMAGES_FOLDER, infoPhotos.install);
    
    if (fs.existsSync(photoPath)) {
        try {
            await ctx.replyWithPhoto({ source: photoPath }, { caption: text });
        } catch (e) {
            console.error('Error sending photo:', e);
            await ctx.reply(text);
        }
    } else {
        await ctx.reply(text);
    }
    
    ctx.reply('Выберите действие:', backButton);
}

// Функция показа информации об оплате и доставке (только текст)
async function showPaymentInfo(ctx) {
    const textParts = [
        `Наш интернет-магазин позаботился о комфорте каждого клиента. Именно поэтому приобретенную на нашем сайте продукцию мы доставляем в любой регион России и предоставляем вам широкий выбор способов доставки и оплаты.

Как оформить заказ?
оформить заказ на сайте, добавив понравившиеся вам товары в корзину. Заказ можно сформировать в любое удобное для вас время суток. В ближайшее время после размещения заказа на сайте Vchehol.ru наши менеджеры свяжутся с вами для его подтверждения и уточнения деталей;
оформить заказ по телефону 8 (958) 510-67-67.`,

        `Способы доставки
Наш интернет-магазин позаботился о комфорте каждого клиента. Именно поэтому приобретенную на нашем сайте продукцию мы доставляем в любой регион России. Скорость доставки зависит от количества заказанных вами товаров, наличия необходимых материалов для пошива на складе компании, а также от адреса получателя.

Курьером в пределах Владимирской области. Стоимость услуги – 400 рублей. Оплата осуществляется заранее, либо наличными по факту получения заказа.
Самовывозом со склада в городе Владимир и Москва. Услуга предоставляется бесплатно.
Транспортными компанией «ПЭК», «Деловые линии». Стоимость услуги зависит от удаленности получателя от города Владимир.
«Почтой России». Стоимость услуги зависит от удаленности получателя от города Владимир.`,

        `Способы оплаты
Клиенты нашего интернет-магазина могут воспользоваться любым удобным вариантом оплаты товара.

Оплата наличными при получении заказа. Преимущество данного способа оплаты – возможность лично проверить наличие и качество заказанных товаров.
Безналичный расчет для юридических лиц. Преимущество данного способа оплаты – гарантия получения товара предоставляется банком, через который производился расчет. После доставка товара вы получаете все необходимые бухгалтерские документы для отчетности.`,

        `Перевод на карту Сбербанка*. Преимущество данного способа оплаты – владельцы карты Сбербанка могут оплатить заказ без начисления специальной комиссии (Скачать реквизиты для оплаты).
Оплата наложенным платежом при доставке «Почтой России» или транспортными компаниями. Преимущество данного способа оплаты – получатель не делает предоплату, а оплачивает товар лишь по факту его получения.
Оплата при помощи платежной системы «Яндекс Деньги» без комиссии. Преимущество данного способа оплаты – возможность оплатить заказ прямо на сайте интернет-магазина сразу после его оформления.`,

        `Как это происходит: Вы оформляете заказ удобным для вас способом. Если заказ был оформлен не по телефону, то в течении суток вам позвонит наш менеджер для подтверждения заказа и уточнения деталей доставка. После этого на указанный вами адрес электронной почты поступит письмо с ссылкой на страницу оплаты вашего заказа. Все введенные вами данные проходят только через сервис «Яндекс Деньги» и полностью защищены. Мы получаем информацию только факте совершенного вами платежа.`,

        `*для оплаты (ввода реквизитов вашей карты) вы будете перенаправлены на платёжный шлюз ПАО СБЕРБАНК. Соединение с платёжным шлюзом и передача информации осуществляется в защищённом режиме с использованием протокола шифрования SSL. В случае если ваш банк поддерживает технологию безопасного проведения интернет-платежей Verified By Visa или MasterCard SecureCode, для проведения платежа также может потребоваться ввод специального пароля.`,

        `Возврат товаров и гарантия
Гарантия 1 год на всю продукицию и возможности приобрести расширенную гарантию на 2 года!

Мы производим возврат и обмен товара с полным соблюдением закона о защите прав потребителя РФ.`,

        `В течение 14 дней, не считая дня покупки. Возврат Товара надлежащего качества возможен только на основании письменного заявления в случае, если сохранены его товарный вид, потребительские свойства, а также товарный и/или кассовый чек, либо иной документ подтверждающий факт и условия покупки указанного Товара.`
    ];

    // Отправляем все части сообщения
    for (const part of textParts) {
        await ctx.reply(part);
    }
    
    await ctx.reply('Выберите действие:', backButton);
}

// Функция показа информации о нас
async function showInfo(ctx, type) {
    let text = '';
    let photoFile = '';
    
    switch(type) {
        case 'about':
            text = infoTexts.about;
            photoFile = infoPhotos.about;
            break;
    }
    
    const photoPath = path.join(IMAGES_FOLDER, photoFile);
    
    if (fs.existsSync(photoPath)) {
        try {
            await ctx.replyWithPhoto({ source: photoPath }, { caption: text });
        } catch (e) {
            console.error('Error sending photo:', e);
            await ctx.reply(text);
        }
    } else {
        await ctx.reply(text);
    }
    
    ctx.reply('Выберите действие:', backButton);
}

// Начало консультации
function startConsultation(ctx) {
    userStates[ctx.from.id] = { step: 'consultation_name' };
    ctx.reply('Пожалуйста, введите ваше ФИО:', Markup.removeKeyboard());
}

// Обработка текстовых сообщений для консультации
bot.on('text', (ctx) => {
    const userId = ctx.from.id;
    const state = userStates[userId];

    if (ctx.message.text === '⬅️ Назад') {
        delete userStates[userId];
        return ctx.reply('Главное меню:', mainMenu);
    }

    if (!state) {
        return ctx.reply('Пожалуйста, выберите действие из меню:', mainMenu);
    }

    if (state.step === 'consultation_name') {
        state.name = ctx.message.text;
        state.step = 'consultation_phone';
        ctx.reply('Теперь введите ваш номер телефона:');
    } else if (state.step === 'consultation_phone') {
        state.phone = ctx.message.text;
        state.step = 'consultation_question';
        ctx.reply('Опишите ваш вопрос:');
    } else if (state.step === 'consultation_question') {
        state.question = ctx.message.text;

        // Отправляем заявку в группу
        const message = `📌 Новая заявка на консультацию:\n\n👤 ФИО: ${state.name}\n📱 Телефон: ${state.phone}\n❓ Вопрос: ${state.question}\nПользователь: @${ctx.from.username || ctx.from.first_name}`;
        bot.telegram.sendMessage(GROUP_ID, message);

        ctx.reply('Спасибо! Ваша заявка отправлена. Мы свяжемся с вами в ближайшее время.', mainMenu);
        delete userStates[userId];
    } else if (state.step === 'order_phone') {
        const phone = ctx.message.text;
        const productId = state.productId;
        const category = state.currentCategory === 'seatCovers' ? 'Авточехлы' : 'Автоковры';
        const products = state.currentCategory === 'seatCovers' ? seatCovers : carMats;
        const product = products.find(p => p.id == productId);

        if (product) {
            const message = `🛒 Новый заказ:\n\nКатегория: ${category}\nТовар: ${product.name}\nТелефон: ${phone}\nПользователь: @${ctx.from.username || ctx.from.first_name}`;
            bot.telegram.sendMessage(GROUP_ID, message);
            ctx.reply('Спасибо! Ваш заказ принят. Мы скоро с вами свяжемся.', mainMenu);
        } else {
            ctx.reply('Произошла ошибка при обработке заказа. Попробуйте еще раз.', mainMenu);
        }

        delete userStates[userId];
    }
});

// Обработка кнопки "Назад"
bot.hears('⬅️ Назад', async (ctx) => {
    console.log('Back button triggered by user:', ctx.from.id);
    try {
        const userId = ctx.from.id;
        if (userStates[userId]) {
            console.log('User state before reset:', userStates[userId]);
            delete userStates[userId];
        }
        await ctx.reply('Главное меню:', mainMenu);
    } catch (error) {
        console.error('Error in back button handler:', error);
        await ctx.reply('Произошла ошибка. Попробуйте ещё раз.', mainMenu);
    }
});

// Обработка inline кнопок заказа
bot.action(/order_(\d+)/, (ctx) => {
    const productId = ctx.match[1];
    const userId = ctx.from.id;
    const state = userStates[userId] || {};
    
    if (state.currentCategory) {
        userStates[userId] = {
            ...state,
            step: 'order_phone',
            productId: productId
        };
        ctx.reply('Пожалуйста, введите ваш номер телефона для оформления заказа:', Markup.removeKeyboard());
    } else {
        ctx.answerCbQuery('Пожалуйста, выберите категорию сначала через меню');
    }
});

// Обработка ошибок
bot.catch((err, ctx) => {
    console.error('❌ Ошибка бота:', err);
    console.error('Контекст ошибки:', ctx);
});

// Запуск бота
async function startBot() {
    try {
        console.log('🟡 Запуск бота AutoAтельe...');
        
        // Тестируем подключение
        const botInfo = await bot.telegram.getMe();
        console.log(`🟢 Бот @${botInfo.username} успешно подключен!`);
        
        // Запускаем бота
        await bot.launch();
        console.log('🚀 Бот успешно запущен и готов к работе!');
        console.log('📱 Перейдите в бота и отправьте /start для начала работы');
        
    } catch (error) {
        console.error('🔴 ОШИБКА ЗАПУСКА БОТА:', error.message);
        console.log('\n💡 ВОЗМОЖНЫЕ ПРИЧИНЫ:');
        console.log('1. Неверный токен бота');
        console.log('2. Проблемы с интернет-соединением');
        console.log('3. Блокировка Telegram в вашем регионе');
        console.log('4. Неправильный формат токена');
        
        process.exit(1);
    }
}

// Обработка завершения работы
process.once('SIGINT', () => {
    console.log('\n🛑 Остановка бота...');
    bot.stop('SIGINT');
    process.exit(0);
});

process.once('SIGTERM', () => {
    console.log('\n🛑 Остановка бота...');
    bot.stop('SIGTERM');
    process.exit(0);
});

// Запуск программы
console.log('🤖 AutoAтельe Bot - Starting...');
startBot();